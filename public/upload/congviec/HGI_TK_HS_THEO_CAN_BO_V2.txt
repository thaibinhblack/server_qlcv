CREATE OR REPLACE PROCEDURE HGI_TK_HS_THEO_CAN_BO_V2 (P_CUR IN OUT SYS_REFCURSOR,
    P_DEN_NGAY NVARCHAR2,
    P_TU_NGAY NVARCHAR2,
    P_MA_DON_VI NVARCHAR2
) IS
BEGIN
OPEN P_CUR FOR
    SELECT   CB.ten_can_bo, CB.ma_can_bo, CB.tai_khoan , count(HS.ma_can_bo_tiep_nhan) as TONG_SO  FROM HS_HO_SO HS
    JOIN HS_CONG_VIEC_HO_SO HSCVHS ON HS.MA_CONG_VIEC_HIEN_TAI = HSCVHS.MA_CONG_VIEC_HO_SO,
    CB_CAN_BO CB 
    where HS.ma_can_bo_tiep_nhan = CB.ma_can_bo 
    AND (TO_DATE(SUBSTR(HS.NGAY_GIO_TIEP_NHAN, 0, 10), 'DD/MM/YYYY') >=  TO_DATE(SUBSTR(P_TU_NGAY, 0, 10), 'DD/MM/YYYY'))
    AND (TO_DATE(SUBSTR(HS.NGAY_GIO_TIEP_NHAN, 0, 10),'DD/MM/YYYY') <= TO_DATE(SUBSTR(P_DEN_NGAY, 0, 10), 'DD/MM/YYYY'))
    AND (P_MA_DON_VI IS NULL OR HSCVHS.MA_DON_VI_THUC_HIEN IN (SELECT CBDV.MA_DON_VI FROM CB_DON_VI CBDV WHERE CBDV.MA_DON_VI = P_MA_DON_VI))
    GROUP BY  HS.ma_can_bo_tiep_nhan, CB.ten_can_bo, CB.tai_khoan, CB.ma_can_bo
    ORDER BY CB.TAI_KHOAN;
END HGI_TK_HS_THEO_CAN_BO_V2;
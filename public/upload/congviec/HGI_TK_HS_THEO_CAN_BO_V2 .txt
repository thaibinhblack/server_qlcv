create or replace PROCEDURE HGI_TK_HS_THEO_CAN_BO_V2 (P_CUR IN OUT SYS_REFCURSOR,
    P_DEN_NGAY NVARCHAR2,
    P_TU_NGAY NVARCHAR2,
    P_MA_DON_VI NVARCHAR2
) IS
BEGIN
OPEN P_CUR FOR
--   SELECT   CB.ten_can_bo, CB.ma_can_bo, CB.tai_khoan ,  count(HS.ma_can_bo_tiep_nhan) as TONG_SO  FROM HS_HO_SO HS,
SELECT TEN_CAN_BO,MA_CAN_BO, TAI_KHOAN, COUNT(DS.MA_CAN_BO) AS TONG_SO FROM (
SELECT DISTINCT  CB.ten_can_bo, CB.ma_can_bo, CB.tai_khoan, HS.MA_HO_SO 
    FROM HS_CONG_VIEC_HO_SO HSCVHS, CB_CAN_BO CB, HS_HO_SO HS
    WHERE CB.MA_CAN_BO = HSCVHS.ma_can_bo_thuc_hien
        AND HS.MA_HO_SO = HSCVHS.MA_HO_SO
        AND EXISTS (SELECT 1 FROM CB_TO_CHUYEN_MON CB_TCM, CB_THUOC_TO_CHUYEN_MON CB_TTCM
        WHERE CB_TTCM.MA_TO_CHUYEN_MON = CB_TCM.MA_TO_CHUYEN_MON 
            AND CB.ma_can_bo = CB_TTCM.MA_CAN_BO
            AND( P_MA_DON_VI IS NULL OR CB_TCM.MA_DON_VI = P_MA_DON_VI))    
        AND CB.MA_CO_QUAN = 'STNMT'
        AND (TO_DATE(SUBSTR(HSCVHS.ngay_gio_bd_cvhs, 0, 10), 'DD/MM/YYYY') >=  TO_DATE(SUBSTR(P_TU_NGAY, 0, 10), 'DD/MM/YYYY'))
        AND (TO_DATE(SUBSTR(HSCVHS.ngay_gio_bd_cvhs, 0, 10),'DD/MM/YYYY') <= TO_DATE(SUBSTR(P_DEN_NGAY , 0, 10), 'DD/MM/YYYY'))
        ) DS GROUP BY DS.TEN_CAN_BO, DS.MA_CAN_BO, DS.TAI_KHOAN;
END HGI_TK_HS_THEO_CAN_BO_V2;